<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8">
<title>Canvia el terra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  padding:20px;
  color:white;
}

/* Marca subtil de fons */
body::before{
  content:"SURFACE AI";
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:120px;
  font-weight:900;
  letter-spacing:12px;
  color:rgba(255,255,255,0.04);
  pointer-events:none;
  z-index:0;
}

.container {
  position:relative;
  z-index:1;
  max-width:1000px;
  margin:auto;
  background:rgba(0,0,0,0.65);
  padding:25px;
  border-radius:16px;
  box-shadow:0 20px 50px rgba(0,0,0,.4);
  backdrop-filter:blur(10px);
}

h1 { margin-top:0;font-size:30px;}
h3 { margin-bottom:10px;}

#room {
  max-width:100%;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.1);
  cursor:crosshair;
}

#dot {
  position:absolute;
  width:14px;
  height:14px;
  background:#2ecc71;
  border-radius:50%;
  transform:translate(-50%,-50%);
}

.materials {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:20px;
  margin-top:15px;
}

.material {
  background:#1e1e1e;
  border-radius:14px;
  overflow:hidden;
  cursor:pointer;
  border:2px solid transparent;
  box-shadow:0 8px 20px rgba(0,0,0,.3);
  transition:.25s ease;
}

.material:hover {
  transform:translateY(-4px);
}

.material.selected {
  border-color:#2ecc71;
  box-shadow:0 0 0 3px rgba(46,204,113,.4);
}

.material img {
  width:100%;
  height:140px;
  object-fit:cover;
}

.material .label {
  padding:10px;
  text-align:center;
  font-weight:600;
}

#coords { margin:10px 0;font-weight:600;}

/* BOTONS MODERNS */
.upload-buttons {
  display:flex;
  gap:12px;
  margin-bottom:15px;
}

.btn-modern {
  background:linear-gradient(135deg,#2ecc71,#27ae60);
  color:white;
  padding:12px 18px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
  border:none;
  font-size:14px;
  transition:.2s ease;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

.btn-modern:hover {
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}

button:disabled {
  background:#555;
  cursor:not-allowed;
}

#status { margin-top:10px;font-weight:600;}

#result {
  display:none;
  margin-top:20px;
  max-width:100%;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.2);
}
</style>
</head>

<body>

<div class="container">

<h1>Canvia el terra</h1>

<p id="accessStatus"></p>
<hr>

<h3>1Ô∏è‚É£ Foto de l‚Äôhabitaci√≥</h3>

<div class="upload-buttons">
  <label class="btn-modern">
    üìÅ Seleccionar foto
    <input type="file" id="roomFile" accept="image/*" hidden>
  </label>

  <button type="button" id="openCamera" class="btn-modern">
    üì∑ Obrir c√†mera
  </button>
</div>

<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">

<div style="position:relative;">
  <img id="room">
  <div id="dot" hidden></div>
</div>

<p id="coords">X: ‚Äî | Y: ‚Äî</p>

<hr>

<h3>2Ô∏è‚É£ Tria el material</h3>
<div class="materials" id="materials"></div>

<p><b>Material seleccionat:</b> <span id="matName">‚Äî</span></p>

<button id="send" class="btn-modern" disabled>Enviar</button>

<p id="status"></p>
<img id="result">

</div>

<script>

/* --- TOT EL TEU JS EXACTAMENT IGUAL --- */

const WEBHOOK_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/Surface-ai";
const VALIDATE_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/validate-code";
const CREATE_CODE_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/create-code";

const MATERIALS = [
  { id:"parquet", name:"Parquet", file:"materials/parquet.jpg" },
  { id:"rajola_gris", name:"Rajola junta grossa", file:"materials/rajola_gris.jpg" },
  { id:"rajola_gris1", name:"Rajola junta fina", file:"materials/rajola_gris1.jpg" }
];

const materialsDiv = document.getElementById("materials");
const matName = document.getElementById("matName");
const sendBtn = document.getElementById("send");
const status = document.getElementById("status");
const roomImg = document.getElementById("room");
const dot = document.getElementById("dot");
const coords = document.getElementById("coords");
const result = document.getElementById("result");

let selectedMaterial = null;
let x=null, y=null;
let accessGranted = false;

/* AUTO LOGIN */
async function autoLogin() {

  const savedCode = localStorage.getItem("accessCode");

  if(!savedCode){
    await createNewCode();
    return;
  }

  try {
    const res = await fetch(VALIDATE_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ code: savedCode })
    });

    const data = await res.json();

    if(data.success){
      accessGranted = true;
      document.getElementById("accessStatus").textContent =
        "Intents restants: " + data.data.remaining_attempts;
      document.getElementById("accessStatus").style.color = "#2ecc71";
    } else {
      accessGranted = false;
      document.getElementById("accessStatus").textContent =
        "Has esgotat els intents o el codi ha caducat.";
      document.getElementById("accessStatus").style.color = "red";
    }

  } catch(err){
    console.error("Error validant codi");
  }
}

async function createNewCode(){
  try {
    const res = await fetch(CREATE_CODE_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({})
    });

    const data = await res.json();

    if(data.success){
      localStorage.setItem("accessCode", data.code);
      accessGranted = true;
      document.getElementById("accessStatus").textContent =
        "Tens 10 intents disponibles (24h)";
      document.getElementById("accessStatus").style.color = "#2ecc71";
    }

  } catch(err){
    console.error("Error generant codi");
  }
}

window.onload = autoLogin;

/* RESTA EXACTA IGUAL */
MATERIALS.forEach(m=>{
  const d=document.createElement("div");
  d.className="material";
  d.innerHTML=`<img src="${m.file}"><div class="label">${m.name}</div>`;
  d.onclick=()=>{
    document.querySelectorAll(".material").forEach(e=>e.classList.remove("selected"));
    d.classList.add("selected");
    selectedMaterial=m;
    matName.textContent=m.id;
    validate();
  };
  materialsDiv.appendChild(d);
});

document.getElementById("roomFile").onchange=e=>{
  roomImg.src=URL.createObjectURL(e.target.files[0]);
  validate();
};

document.getElementById("openCamera").onclick=function(){
  document.getElementById("cameraInput").click();
};

document.getElementById("cameraInput").onchange=function(e){
  const file=e.target.files[0];
  if(file){
    roomImg.src=URL.createObjectURL(file);
    const dt=new DataTransfer();
    dt.items.add(file);
    document.getElementById("roomFile").files=dt.files;
    validate();
  }
};

roomImg.onclick=e=>{
  const r=roomImg.getBoundingClientRect();
  x=Math.round(e.clientX-r.left);
  y=Math.round(e.clientY-r.top);
  dot.style.left=x+"px";
  dot.style.top=y+"px";
  dot.hidden=false;
  coords.textContent=`X: ${x} | Y: ${y}`;
  validate();
};

function validate(){
  sendBtn.disabled=!(selectedMaterial && x!==null && document.getElementById("roomFile").files[0]);
}

async function urlToFile(url,name){
  const r=await fetch(url);
  const b=await r.blob();
  return new File([b],name,{type:b.type});
}

sendBtn.onclick=async()=>{
  if(!accessGranted){
    alert("Acc√©s no disponible.");
    return;
  }

  status.textContent="Processant...";

  const fd=new FormData();
  fd.append("access_code", localStorage.getItem("accessCode"));
  fd.append("room_image",document.getElementById("roomFile").files[0]);
  fd.append("material_image",await urlToFile(selectedMaterial.file,selectedMaterial.id+".jpg"));
  fd.append("material_name",selectedMaterial.id);
  fd.append("x",x);
  fd.append("y",y);

  const res=await fetch(WEBHOOK_URL,{method:"POST",body:fd});
  const blob=await res.blob();
  result.src=URL.createObjectURL(blob);
  result.style.display="block";
  status.textContent="Fet ‚úÖ";
};

</script>

</body>
</html>
