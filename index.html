<!doctype html>
<html lang="ca">
<head>
<meta charset="utf-8">
<title>Canvia el terra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family:"Segoe UI",Arial,sans-serif;background:#f6f6f6;margin:0;padding:20px;}
.container { max-width:1000px;margin:auto;background:white;padding:20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
h1 { margin-top:0;font-size:28px;}
h3 { margin-bottom:10px;}
input[type=file] { margin-bottom:15px;}
#room { max-width:100%;border-radius:10px;border:1px solid #ddd;cursor:crosshair;}
#dot { position:absolute;width:14px;height:14px;background:red;border-radius:50%;transform:translate(-50%,-50%);}
.materials { display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-top:15px;}
.material { background:#fff;border-radius:12px;overflow:hidden;cursor:pointer;border:2px solid transparent;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:.2s;}
.material:hover { transform:translateY(-3px);}
.material.selected { border-color:#2ecc71;box-shadow:0 0 0 3px rgba(46,204,113,.3);}
.material img { width:100%;height:140px;object-fit:cover;}
.material .label { padding:10px;text-align:center;font-weight:600;}
#coords { margin:10px 0;font-weight:600;}
button { background:#2ecc71;color:white;border:none;padding:14px 20px;font-size:16px;border-radius:10px;cursor:pointer;}
button:disabled { background:#ccc;cursor:not-allowed;}
#status { margin-top:10px;font-weight:600;}
#result { display:none;margin-top:20px;max-width:100%;border-radius:12px;border:1px solid #ddd;}
</style>
</head>

<body>

<div class="container">

<h1>Canvia el terra</h1>

<p id="accessStatus"></p>
<hr>

<h3>1Ô∏è‚É£ Foto de l‚Äôhabitaci√≥</h3>
<input type="file" id="roomFile" accept="image/*">

<div style="position:relative;">
  <img id="room">
  <div id="dot" hidden></div>
</div>

<p id="coords">X: ‚Äî | Y: ‚Äî</p>

<hr>

<h3>2Ô∏è‚É£ Tria el material</h3>
<div class="materials" id="materials"></div>

<p><b>Material seleccionat:</b> <span id="matName">‚Äî</span></p>

<button id="send" disabled>Enviar</button>

<p id="status"></p>
<img id="result">

</div>

<script>

/* üî• URLS PRODUCCI√ì DEFINITIVES */
const WEBHOOK_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/Surface-ai";
const VALIDATE_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/validate-code";
const CREATE_CODE_URL = "https://jan-n8n.4tpc2e.easypanel.host/webhook/create-code";

const MATERIALS = [
  { id:"parquet", name:"Parquet", file:"materials/parquet.jpg" },
  { id:"rajola_gris", name:"Rajola junta grossa", file:"materials/rajola_gris.jpg" },
  { id:"rajola_gris1", name:"Rajola junta fina", file:"materials/rajola_gris1.jpg" }
];

const materialsDiv = document.getElementById("materials");
const matName = document.getElementById("matName");
const sendBtn = document.getElementById("send");
const status = document.getElementById("status");
const roomImg = document.getElementById("room");
const dot = document.getElementById("dot");
const coords = document.getElementById("coords");
const result = document.getElementById("result");

let selectedMaterial = null;
let x=null, y=null;
let accessGranted = false;
let currentCode = null;

/* ---------- üîê AUTO LOGIN CONTROLAT ---------- */

async function autoLogin() {

  const savedCode = localStorage.getItem("accessCode");

  // Si no t√© codi ‚Üí genera un (nom√©s la primera vegada)
  if(!savedCode){

    try {
      const res = await fetch(CREATE_CODE_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({})
      });

      const data = await res.json();

      if(data.success){
        localStorage.setItem("accessCode", data.code);
        currentCode = data.code;
        accessGranted = true;
        document.getElementById("accessStatus").textContent = 
          "Acc√©s activat (24h / 10 intents)";
        document.getElementById("accessStatus").style.color = "green";
      }

    } catch(err){
      console.error("Error generant codi");
    }

    return;
  }

  // Si t√© codi ‚Üí el validem
  try {

    const res = await fetch(VALIDATE_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ code: savedCode })
    });

    const data = await res.json();

    if(data.success){
      currentCode = savedCode;
      accessGranted = true;
      document.getElementById("accessStatus").textContent = 
        "Acc√©s actiu. Intents restants: " + data.data.remaining_attempts;
      document.getElementById("accessStatus").style.color = "green";
    } else {
      localStorage.removeItem("accessCode");
      accessGranted = false;
      document.getElementById("accessStatus").textContent = 
        "Acc√©s caducat. Torna a la botiga per activar-lo.";
      document.getElementById("accessStatus").style.color = "red";
    }

  } catch(err){
    console.error("Error validant codi");
  }
}

window.onload = autoLogin;

/* ---------- MATERIALS ---------- */

MATERIALS.forEach(m=>{
  const d=document.createElement("div");
  d.className="material";
  d.innerHTML=`<img src="${m.file}"><div class="label">${m.name}</div>`;
  d.onclick=()=>{
    document.querySelectorAll(".material").forEach(e=>e.classList.remove("selected"));
    d.classList.add("selected");
    selectedMaterial=m;
    matName.textContent=m.id;
    validate();
  };
  materialsDiv.appendChild(d);
});

document.getElementById("roomFile").onchange=e=>{
  roomImg.src=URL.createObjectURL(e.target.files[0]);
};

roomImg.onclick=e=>{
  const r=roomImg.getBoundingClientRect();
  x=Math.round(e.clientX-r.left);
  y=Math.round(e.clientY-r.top);
  dot.style.left=x+"px";
  dot.style.top=y+"px";
  dot.hidden=false;
  coords.textContent=`X: ${x} | Y: ${y}`;
  validate();
};

function validate(){
  sendBtn.disabled=!(selectedMaterial && x!==null && document.getElementById("roomFile").files[0]);
}

/* ---------- ENVIAMENT ---------- */

async function urlToFile(url,name){
  const r=await fetch(url);
  const b=await r.blob();
  return new File([b],name,{type:b.type});
}

sendBtn.onclick=async()=>{

  if(!accessGranted){
    alert("Acc√©s no disponible.");
    return;
  }

  status.textContent="Processant...";

  const fd=new FormData();
  fd.append("room_image",document.getElementById("roomFile").files[0]);
  fd.append("material_image",await urlToFile(selectedMaterial.file,selectedMaterial.id+".jpg"));
  fd.append("material_name",selectedMaterial.id);
  fd.append("x",x);
  fd.append("y",y);

  const res=await fetch(WEBHOOK_URL,{method:"POST",body:fd});
  const blob=await res.blob();
  result.src=URL.createObjectURL(blob);
  result.style.display="block";
  status.textContent="Fet ‚úÖ";
};

</script>

</body>
</html>



